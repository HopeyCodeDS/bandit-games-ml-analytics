image: docker:latest

services:
  - docker:dind

variables:
  # Docker Hub images
  DOCKER_HUB_USER: opeyemimomodu
  STATS_DB_IMAGE: ${DOCKER_HUB_USER}/statistics-db
  STATS_API_IMAGE: ${DOCKER_HUB_USER}/statistics-api
  PREDICTION_IMAGE: ${DOCKER_HUB_USER}/prediction-api
  ANALYTICS_CONSUMER_IMAGE: ${DOCKER_HUB_USER}/analytics-consumer

stages:
  - build
  - deploy

# Build jobs with Docker login
.build_template: &build_definition
  stage: build
  before_script:
    - echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_USER" --password-stdin
  only:
    - main

build_stats_db:
  <<: *build_definition
  script:
    - docker build -t $STATS_DB_IMAGE:$CI_COMMIT_SHA -f game_analytics_docker/Dockerfile game_analytics_docker
    - docker tag $STATS_DB_IMAGE:$CI_COMMIT_SHA $STATS_DB_IMAGE:latest
    - docker push $STATS_DB_IMAGE:$CI_COMMIT_SHA
    - docker push $STATS_DB_IMAGE:latest

build_stats_api:
  <<: *build_definition
  script:
    - docker build -t $STATS_API_IMAGE:$CI_COMMIT_SHA -f GameAnalytics/Dockerfile GameAnalytics
    - docker tag $STATS_API_IMAGE:$CI_COMMIT_SHA $STATS_API_IMAGE:latest
    - docker push $STATS_API_IMAGE:$CI_COMMIT_SHA
    - docker push $STATS_API_IMAGE:latest

build_prediction_api:
  <<: *build_definition
  script:
    - docker build -t $PREDICTION_IMAGE:$CI_COMMIT_SHA -f PredictionSystem/Dockerfile PredictionSystem
    - docker tag $PREDICTION_IMAGE:$CI_COMMIT_SHA $PREDICTION_IMAGE:latest
    - docker push $PREDICTION_IMAGE:$CI_COMMIT_SHA
    - docker push $PREDICTION_IMAGE:latest

build_analytics_consumer:
  <<: *build_definition
  script:
    - docker build -t $ANALYTICS_CONSUMER_IMAGE:$CI_COMMIT_SHA -f communication/Dockerfile communication
    - docker tag $ANALYTICS_CONSUMER_IMAGE:$CI_COMMIT_SHA $ANALYTICS_CONSUMER_IMAGE:latest
    - docker push $ANALYTICS_CONSUMER_IMAGE:$CI_COMMIT_SHA
    - docker push $ANALYTICS_CONSUMER_IMAGE:latest


# Deploy to Azure
# Deploy job without Docker login
deploy:
  stage: deploy
  image: mcr.microsoft.com/azure-cli
  script:
    - echo "Starting deployment to Azure..."

    # Docker Hub login for pulling images
    - echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_USER" --password-stdin

    # Azure Login
    - az login --service-principal -u "$AZURE_SP_ID" -p "$AZURE_SP_PASSWORD" --tenant "$AZURE_TENANT_ID"

    # Register Container Instance provider
    - echo "Registering Container Instance provider..."
    - az provider register --namespace Microsoft.ContainerInstance

    # Create resource group
    - az group create --name game-analytics-rg --location westeurope
    - |
      if ! az login --service-principal \
        -u "$AZURE_SP_ID" \
        -p "$AZURE_SP_PASSWORD" \
        --tenant "$AZURE_TENANT_ID"; then
        echo "Failed to login to Azure"
        exit 1
      fi

    - |
      if ! az group create \
        --name game-analytics-rg \
        --location westeurope; then
        echo "Failed to create resource group"
        exit 1
      fi

    # Deploy container group
    - |
      az container create \
        --resource-group game-analytics-rg \
        --name game-analytics-platform \
        --image $STATS_DB_IMAGE:latest \
        --image $STATS_API_IMAGE:latest \
        --image $PREDICTION_IMAGE:latest \
        --image $ANALYTICS_CONSUMER_IMAGE:latest \
        --dns-name-label game-analytics-platform \
        --ports 3309 8001 8002 \
        --environment-variables \
          MYSQL_DATABASE=platform_analytics \
          MYSQL_ROOT_PASSWORD=$DB_ROOT_PASSWORD \
          RABBITMQ_HOST=48.209.190.184 \
          RABBITMQ_PORT=5672 \
          RABBITMQ_USERNAME=myuser \
        --os-type Linux \
        --memory 1.5 \
        --cpu 1 \
        --registry-username $DOCKER_HUB_USER \
        --registry-password $DOCKER_HUB_PASSWORD \
        --debug

  needs:
    - build_stats_db
    - build_stats_api
    - build_prediction_api
    - build_analytics_consumer
  only:
    - main
  environment: production